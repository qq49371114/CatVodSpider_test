name: Merge-upstream åˆå¹¶ä¸Šæ¸¸
on:
  # å½“ä»£ç æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ã€‚
  # push:
  #   # æŒ‡å®šæ–‡ä»¶è·¯å¾„ä¼šè§¦å‘å·¥ä½œæµç¨‹
  #   paths:
  #     - '.github/workflows/upstream.yml'
  #     - '.gitignore'
  #     - '.github/diy/**'
  # # æŒ‰è®¡åˆ’å®šæœŸè§¦å‘ï¼Œä¾‹å¦‚æ¯ 12 å°æ—¶ä¸€æ¬¡ã€‚
  # schedule:
  #   - cron: 0 */12 * * *
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¨‹ã€‚
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  # # å½“ä»“åº“è¢«å…³æ³¨æ—¶è§¦å‘ã€‚
  # watch:
  #   types: started
  # # é€šè¿‡å¤–éƒ¨äº‹ä»¶è§¦å‘ã€‚
  # repository_dispatch:

jobs:
  merge:
    runs-on: Ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 0
    
    - name: Set git identity è®¾ç½®gitæ ‡è¯†
      run : |
        git config --global user.email "54346276+asxs123@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Syn upstream  åŒæ­¥ä¸Šæ¸¸
      run: |
        # å¯ç”¨æ‰©å±•çš„æ¨¡å¼åŒ¹é…
        shopt -s extglob
        # å…³é—­è„šæœ¬ä¸­çš„é”™è¯¯ç»ˆæ­¢
        set +e
        # ä»ç¼“å­˜ä¸­åˆ é™¤æ‰€æœ‰æ–‡ä»¶,ä¸æ˜¾ç¤ºä»»ä½•è¾“å‡º
        git rm -r --cache * >/dev/null 2>&1 &
        # åˆ é™¤é™¤ .github/diy ä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶å¤¹ã€‚find æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹ï¼Œ-maxdepth 0 åªæœç´¢å½“å‰ç›®å½•ï¼Œ-type d åªæœç´¢æ–‡ä»¶å¤¹ï¼Œ! -name ".github/diy" æ’é™¤åä¸º .github/diy çš„æ–‡ä»¶å¤¹ã€‚
        rm -rf `find ./* -maxdepth 0 -type d ! -name "app/src/main/java/com/github/catvod/spider"` >/dev/null 2>&1
        function git_clone() {
          # å…‹éš†æŒ‡å®šä»“åº“ --depth 1 åªå…‹éš†æœ€è¿‘ä¸€æ¬¡æäº¤ $1 å’Œ $2 æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºä»“åº“ URL å’Œç›®æ ‡ç›®å½•ã€‚
          git clone --depth 1 $1 $2
          if [ "$?" != 0 ]; then
            # å‘½ä»¤æ‰§è¡Œå¤±è´¥,è¾“å‡ºé”™è¯¯ä¿¡æ¯,è·å–å½“å‰è¿›ç¨‹çš„ PID,ç»ˆæ­¢å½“å‰è¿›ç¨‹
            echo "error on $1"
            pid="$( ps -q $$ )"
            kill $pid
          fi
        }
        (
          git_clone https://github.com/FongMi/CatVodSpider temp-dir
          mv temp-dir/* temp-dir/.[^.]* .
          rm -rf temp-dir
          rm -rf app/src/main/java/com/github/catvod/spider/Doll.java
          rm -rf app/src/main/java/com/github/catvod/spider/Eighteen.java
          rm -rf app/src/main/java/com/github/catvod/spider/Hanime.java
          rm -rf app/src/main/java/com/github/catvod/spider/Jable.java
          rm -rf app/src/main/java/com/github/catvod/spider/JavDb.java
          rm -rf app/src/main/java/com/github/catvod/spider/Miss.java
          rm -rf app/src/main/java/com/github/catvod/spider/Kanqiu.java
          rm -rf app/src/main/java/com/github/catvod/spider/Star.java
          rm -rf app/src/main/java/com/github/catvod/spider/TvDy.java
          rm -rf app/src/main/java/com/github/catvod/spider/PanSearch.java
          rm -rf app/src/main/java/com/github/catvod/spider/PanSou.java
          rm -rf app/src/main/java/com/github/catvod/spider/UpYun.java
          rm -rf app/src/main/java/com/github/catvod/spider/Wogg.java
          rm -rf app/src/main/java/com/github/catvod/spider/XiaoZhiTiao.java
          rm -rf app/src/main/java/com/github/catvod/spider/YiSo.java
          rm -rf app/src/main/java/com/github/catvod/spider/Zhaozy.java
          sed -i "/Doll/d" app/src/main/java/com/github/catvod/debug/MainActivity.java
          rm -rf app/src/main/java/com/github/catvod/spider/JustLive.java
          sed -i 's/compileSdk 35/compileSdk 34/g' app/build.gradle
          sed -i 's/targetSdk 35/targetSdk 33/g' app/build.gradle
        )
        (
          #å¢åŠ lushunmingçˆ¬è™«
          # curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/spider/ChangZhang.java > app/src/main/java/com/github/catvod/spider/ChangZhang.java
          # curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/bean/Result.java > app/src/main/java/com/github/catvod/bean/Result.java
          curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/spider/Ikanbot.java > app/src/main/java/com/github/catvod/spider/Ikanbot.java
          curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/spider/TvDy.java > app/src/main/java/com/github/catvod/spider/TvDy.java
          sed -i 's#"ç¦åˆ©", ##g' app/src/main/java/com/github/catvod/spider/TvDy.java
          sed -i 's#"5", ##g' app/src/main/java/com/github/catvod/spider/TvDy.java
          # curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/spider/NCat.java > app/src/main/java/com/github/catvod/spider/NCat.java
          curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/utils/ProxyVideo.java > app/src/main/java/com/github/catvod/utils/ProxyVideo.java
          curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/utils/Json.java > app/src/main/java/com/github/catvod/utils/Json.java
          curl -L https://raw.githubusercontent.com/lushunming/AndroidCatVodSpider/refs/heads/mine/app/src/main/java/com/github/catvod/utils/Util.java > app/src/main/java/com/github/catvod/utils/Util.java
        )
        # (
        #   #å¢åŠ zhixcçˆ¬è™«
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/spider/Anime1.java > app/src/main/java/com/github/catvod/spider/Anime1.java
        #   mkdir app/src/main/java/com/github/catvod/utils/okhttp
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/utils/okhttp/OkHttpUtil.java > app/src/main/java/com/github/catvod/utils/okhttp/OkHttpUtil.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/utils/okhttp/OKCallBack.java > app/src/main/java/com/github/catvod/utils/okhttp/OKCallBack.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/utils/okhttp/SSLSocketFactoryCompat.java > app/src/main/java/com/github/catvod/utils/SSLSocketFactoryCompat.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/utils/okhttp/OKRequest.java > app/src/main/java/com/github/catvod/utils/okhttp/OKRequest.java
        #   mkdir app/src/main/java/com/github/catvod/parser
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/parser/JsonParallel.java > app/src/main/java/com/github/catvod/parser/JsonParallel.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/parser/JsonBasic.java > app/src/main/java/com/github/catvod/parser/JsonBasic.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/parser/JsonSequence.java > app/src/main/java/com/github/catvod/parser/JsonSequence.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/parser/MixDemo.java > app/src/main/java/com/github/catvod/parser/MixDemo.java
        #   curl -L https://raw.githubusercontent.com/zhixc/CatVodTVSpider/main/app/src/main/java/com/github/catvod/parser/MixWeb.java > app/src/main/java/com/github/catvod/parser/MixWeb.java
        # )
        # # (
        # #   #å¢åŠ xyzjheçˆ¬è™«
        # #   curl -L https://raw.githubusercontent.com/xyzjhe/test_jar/main/app/src/main/java/com/github/catvod/spider/AppTT.java > app/src/main/java/com/github/catvod/spider/AppTT.java
        # # )
        # (
        #   #å¢åŠ zwm001çˆ¬è™«
        #   curl -L https://raw.githubusercontent.com/zwm001/JarMax/master/app/src/main/java/com/github/catvod/spider/Czsapp.java > app/src/main/java/com/github/catvod/spider/Czsapp.java
        #   curl -L https://raw.githubusercontent.com/zwm001/JarMax/master/app/src/main/java/com/github/catvod/utils/AES.java > app/src/main/java/com/github/catvod/utils/AES.java
        #   curl -L https://raw.githubusercontent.com/zwm001/JarMax/master/app/src/main/java/com/github/catvod/utils/CBC.java > app/src/main/java/com/github/catvod/utils/CBC.java
        #   curl -L https://raw.githubusercontent.com/zwm001/JarMax/master/app/src/main/java/com/github/catvod/utils/gZip.java > app/src/main/java/com/github/catvod/utils/gZip.java
        #   curl -L https://raw.githubusercontent.com/zwm001/JarMax/master/app/src/main/java/com/github/catvod/utils/Misc.java > app/src/main/java/com/github/catvod/utils/Misc.java
        # )
        
    - name: Apply åº”ç”¨
      run: |
        # å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ Emojiï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒçš„ emoji è¡¨æƒ…
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        # å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ° Git æš‚å­˜åŒº
        git add .
        # åˆ›å»ºä¸€ä¸ªæäº¤ï¼ŒåŒ…å«äº†éšæœºé€‰æ‹©çš„ emoji å’Œå½“å‰æ—¥æœŸæ—¶é—´ä½œä¸ºæäº¤ä¿¡æ¯
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # æ’¤é”€ä¸Šä¸€æ¬¡æäº¤ï¼Œä½†ä¿ç•™æ›´æ”¹
        git reset --soft HEAD^
        git add .
        git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        # å¼ºåˆ¶æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
        git push -f

    - name: Delete workflow runs åˆ é™¤å·¥ä½œæµè¿è¡Œ
      uses: Mattraks/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: 1
        keep_minimum_runs: 3
